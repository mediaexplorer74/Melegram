<Page
    x:Class="TelegramClient.ChatPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:TelegramClient"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    d:DesignHeight="696"
    d:DesignWidth="480">

    <Grid x:Name="LayoutRoot" Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Title Panel -->
        <StackPanel Grid.Row="0" Margin="12,17,0,28">
            <TextBlock x:Name="PageTitle" Text="Chat" Style="{ThemeResource HeaderTextBlockStyle}"/>
            <TextBlock x:Name="PageSubtitle" Text="Loading..." Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"/>
        </StackPanel>

        <!-- Loading State -->
        <Grid x:Name="LoadingPanel" Grid.Row="1" Visibility="Visible">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="20" Margin="0,0,0,20"/>
                <TextBlock HorizontalAlignment="Center" 
                           Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"
                           FontSize="16" TextAlignment="Center" Height="164" Width="444"> 
    <Run Text=" loading messages" />
    <LineBreak />
    <LineBreak />
    <Run Text=" Time depends on network speed / server" />
                <LineBreak />
    <Run Text=" App Version: BETA 2.0" />
                </TextBlock>
            </StackPanel>
        </Grid>

        <!-- Messages List (Hidden during loading) -->
        <ListBox x:Name="MessagesListBox" 
                 Grid.Row="1" 
                 Margin="12,0,12,0"
                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                 Visibility="Collapsed">
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <StackPanel Margin="0,8">
                        <!-- Message Header -->
                        <TextBlock Text="{Binding SenderName}" 
                                   Foreground="{ThemeResource SystemAccentColor}"
                                   FontSize="12"
                                   Visibility="{Binding ShowSenderVisibility}"/>

                        <!-- Message Bubble -->
                        <Border Background="{Binding BackgroundColor}" 
                                Margin="{Binding BubbleMargin}"
                                HorizontalAlignment="{Binding HorizontalAlignment}">
                            <StackPanel>
                                <TextBlock Text="{Binding Text}" 
                                           TextWrapping="Wrap" 
                                           Margin="12,8,12,8"
                                           Foreground="{Binding TextColor}"
                                           FontSize="16"/>
                                
                                <!-- Message Time -->
                                <TextBlock Text="{Binding Time}" 
                                           HorizontalAlignment="Right" 
                                           Margin="0,0,12,4"
                                           Foreground="{Binding TimeColor}"
                                           FontSize="12"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Message Input Panel (Hidden during loading) -->
        <Grid x:Name="InputPanel" 
              Grid.Row="2" 
              Background="{ThemeResource AppBarBackgroundThemeBrush}"
              Visibility="Collapsed">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBox x:Name="MessageTextBox" 
                     Grid.Column="0" 
                     Margin="12,8,12,8"
                     Height="72"
                     FontSize="16"
                     KeyDown="MessageTextBox_KeyDown"/>

            <Button x:Name="SendButton" 
                    Grid.Column="1" 
                    Content="Send" 
                    Click="SendButton_Click"
                    Margin="0,8,12,8"
                    Width="100"
                    Height="72"
                    Background="{ThemeResource SystemAccentColor}"
                    Foreground="White"/>
        </Grid>

        <!-- Error State (Hidden by default) -->
        <Grid x:Name="ErrorPanel" Grid.Row="1" Visibility="Collapsed">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="⚠️" 
                           FontSize="48" 
                           HorizontalAlignment="Center"
                           Margin="0,0,0,20"/>
                <TextBlock x:Name="ErrorText" 
                           Text="Failed to load messages" 
                           TextWrapping="Wrap" 
                           HorizontalAlignment="Center"
                           TextAlignment="Center"
                           Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"
                           FontSize="16"
                           Margin="20,0,20,20"/>
                <Button Content="Try Again" 
                        Click="RetryLoading_Click"
                        Background="{ThemeResource SystemAccentColor}"
                        Foreground="White"
                        Width="200"
                        Height="60"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>